<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chronicles of Aetheria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #050505;
            color: #e5e7eb;
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow: hidden;
        }
        .font-cinzel { font-family: 'Cinzel', serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #444; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in { animation: fadeIn 0.8s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        
        .glass-panel {
            background: rgba(15, 15, 15, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
<script type="importmap">
{
  "imports": {
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react": "https://esm.sh/react@^19.2.3",
    "react/": "https://esm.sh/react@^19.2.3/",
    "vite": "https://esm.sh/vite@^7.3.0",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2"
  }
}
</script>
</head>
<body>
    <div id="root"></div>

    <script type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@19.2.3';
        import ReactDOM from 'https://esm.sh/react-dom@19.2.3/client';
        import htm from 'https://esm.sh/htm';
        import { GoogleGenAI, Type } from 'https://esm.sh/@google/genai';

        const html = htm.bind(React.createElement);

        // --- GEMINI SERVICE ---
        const SYSTEM_INSTRUCTION = `
            You are a master Dungeon Master for "Chronicles of Aetheria".
            1. Narrate in the second person (e.g., "You enter...").
            2. Address the player by their chosen Character Name.
            3. Keep narrative atmosphere thick, dark, and under 120 words.
            4. Include mechanical updates (Health/Mana/Inventory) in every response.
            5. Always follow the specified JSON schema.
            6. Generate a 15-word vivid visual prompt for an image representing the scene.
        `;

        async function processGameAction(action, state) {
            const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
            const model = "gemini-3-flash-preview";
            
            const prompt = `
                Player Name: ${state.characterName}
                Current State: ${JSON.stringify({
                    health: state.health,
                    mana: state.mana,
                    inventory: state.inventory,
                    location: state.location
                })}
                Player Action: ${action}
            `;

            const response = await ai.models.generateContent({
                model,
                contents: prompt,
                config: {
                    systemInstruction: SYSTEM_INSTRUCTION,
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: Type.OBJECT,
                        properties: {
                            narrative: { type: Type.STRING },
                            imagePrompt: { type: Type.STRING },
                            healthChange: { type: Type.INTEGER },
                            manaChange: { type: Type.INTEGER },
                            newItems: { type: Type.ARRAY, items: { type: Type.STRING } },
                            lostItems: { type: Type.ARRAY, items: { type: Type.STRING } },
                            location: { type: Type.STRING }
                        },
                        required: ["narrative", "imagePrompt", "healthChange", "manaChange", "newItems", "lostItems", "location"]
                    }
                }
            });

            return JSON.parse(response.text);
        }

        async function generateSceneImage(prompt) {
            try {
                const ai = new GoogleGenAI({ apiKey: process.env.API_KEY || '' });
                const response = await ai.models.generateContent({
                    model: 'gemini-2.5-flash-image',
                    contents: { 
                        parts: [{ text: `Dark fantasy cinematic concept art, ethereal lighting, hyper-detailed: ${prompt}` }] 
                    },
                    config: { imageConfig: { aspectRatio: "16:9" } }
                });
                
                for (const part of response.candidates?.[0]?.content?.parts || []) {
                    if (part.inlineData) return `data:image/png;base64,${part.inlineData.data}`;
                }
                return null;
            } catch (e) {
                console.error("Image generation failed", e);
                return null;
            }
        }

        // --- COMPONENTS ---
        const StatsBar = ({ health, mana }) => html`
            <div className="flex flex-col gap-4 p-4 glass-panel rounded-2xl">
                <div className="space-y-1">
                    <div className="flex justify-between text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                        <span>Vitality</span>
                        <span className=${health < 30 ? 'text-red-500' : 'text-zinc-400'}>${health}%</span>
                    </div>
                    <div className="w-full bg-zinc-900 h-1 rounded-full overflow-hidden">
                        <div className="h-full bg-red-800 transition-all duration-1000" style=${{ width: `${health}%` }} />
                    </div>
                </div>
                <div className="space-y-1">
                    <div className="flex justify-between text-[10px] font-bold uppercase tracking-widest text-zinc-500">
                        <span>Aether</span>
                        <span className="text-zinc-400">${mana}%</span>
                    </div>
                    <div className="w-full bg-zinc-900 h-1 rounded-full overflow-hidden">
                        <div className="h-full bg-blue-800 transition-all duration-1000" style=${{ width: `${mana}%` }} />
                    </div>
                </div>
            </div>
        `;

        const Inventory = ({ items }) => html`
            <div className="p-4 glass-panel rounded-2xl">
                <h3 className="text-[10px] font-bold uppercase tracking-widest text-zinc-500 mb-3 flex items-center gap-2">
                    <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>
                    Pouch
                </h3>
                <div className="flex flex-wrap gap-2">
                    ${items.length === 0 ? html`<span className="text-[10px] italic text-zinc-600">Nothing but dust...</span>` : items.map(item => html`
                        <div key=${item} className="px-2 py-1 bg-zinc-900 border border-zinc-800 rounded text-[10px] text-zinc-400 hover:border-amber-900/50 transition-colors">
                            ${item}
                        </div>
                    `)}
                </div>
            </div>
        `;

        // --- APP ---
        const App = () => {
            const [gameState, setGameState] = useState({
                characterName: '',
                health: 100,
                mana: 80,
                inventory: ['Worn Coin', 'Obsidian Shard'],
                location: 'Void Threshold',
                history: [],
                isStarted: false
            });

            const [input, setInput] = useState('');
            const [loading, setLoading] = useState(false);
            const [image, setImage] = useState(null);
            const logRef = useRef(null);

            useEffect(() => {
                logRef.current?.scrollTo({ top: logRef.current.scrollHeight, behavior: 'smooth' });
            }, [gameState.history, loading]);

            const startStory = async (e) => {
                e.preventDefault();
                if (!gameState.characterName.trim()) return;
                
                setLoading(true);
                const initialAction = "You stand at the threshold of Aetheria. Tell me where I am and what I see.";
                try {
                    const res = await processGameAction(initialAction, { ...gameState, history: [] });
                    const initialImg = await generateSceneImage(res.imagePrompt);
                    
                    setImage(initialImg);
                    setGameState(prev => ({
                        ...prev,
                        isStarted: true,
                        location: res.location,
                        history: [{ type: 'narrative', content: res.narrative }]
                    }));
                } catch (err) {
                    console.error(err);
                } finally {
                    setLoading(false);
                }
            };

            const handleAction = async (e) => {
                e.preventDefault();
                if (!input.trim() || loading) return;

                const userAction = input;
                setInput('');
                setLoading(true);
                
                setGameState(prev => ({
                    ...prev,
                    history: [...prev.history, { type: 'action', content: userAction }]
                }));

                try {
                    const res = await processGameAction(userAction, gameState);
                    const newImg = await generateSceneImage(res.imagePrompt);
                    if (newImg) setImage(newImg);

                    setGameState(prev => ({
                        ...prev,
                        health: Math.max(0, Math.min(100, prev.health + res.healthChange)),
                        mana: Math.max(0, Math.min(100, prev.mana + res.manaChange)),
                        location: res.location,
                        inventory: [...prev.inventory.filter(i => !res.lostItems.includes(i)), ...res.newItems],
                        history: [...prev.history, { type: 'narrative', content: res.narrative }]
                    }));
                } catch (err) {
                    setGameState(prev => ({
                        ...prev,
                        history: [...prev.history, { type: 'system', content: 'The winds of fate are turbulent. Try again.' }]
                    }));
                } finally {
                    setLoading(false);
                }
            };

            if (!gameState.isStarted) {
                return html`
                    <div className="h-screen flex items-center justify-center p-6 bg-[#050505] relative overflow-hidden">
                        <div className="absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-amber-900/10 via-transparent to-transparent opacity-50" />
                        <div className="max-w-md w-full glass-panel p-8 rounded-3xl text-center space-y-8 animate-fade-in relative z-10">
                            <div className="space-y-2">
                                <h1 className="font-cinzel text-4xl font-bold tracking-[0.2em] text-amber-600">AETHERIA</h1>
                                <p className="text-[10px] uppercase tracking-[0.4em] text-zinc-500">Chronicles of the Void</p>
                            </div>
                            
                            <form onSubmit=${startStory} className="space-y-4">
                                <div className="space-y-1 text-left">
                                    <label className="text-[10px] font-bold uppercase tracking-widest text-zinc-500 ml-1">Hero's Name</label>
                                    <input 
                                        autoFocus
                                        type="text" 
                                        placeholder="Kaelen, Thorne, etc..."
                                        className="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl px-4 py-3 text-zinc-200 placeholder-zinc-700 focus:outline-none focus:border-amber-900/50 transition-all"
                                        value=${gameState.characterName}
                                        onChange=${e => setGameState(prev => ({ ...prev, characterName: e.target.value }))}
                                    />
                                </div>
                                <button 
                                    disabled=${!gameState.characterName || loading}
                                    className="w-full bg-amber-700 hover:bg-amber-600 disabled:bg-zinc-800 text-black font-bold text-xs uppercase tracking-[0.3em] py-4 rounded-xl transition-all shadow-xl shadow-amber-900/20 active:scale-95"
                                >
                                    ${loading ? 'Consulting Fate...' : 'Enter the Void'}
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            }

            return html`
                <div className="flex flex-col md:flex-row h-screen bg-[#050505] text-zinc-300">
                    <aside className="w-full md:w-80 border-r border-zinc-900/50 p-6 flex flex-col gap-6 bg-[#080808] z-20">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded bg-amber-900/20 flex items-center justify-center border border-amber-900/30">
                                <span className="font-cinzel text-amber-600 font-bold">A</span>
                            </div>
                            <div>
                                <h1 className="font-cinzel text-sm font-bold tracking-widest text-amber-600">AETHERIA</h1>
                                <div className="text-[8px] text-zinc-600 uppercase tracking-widest">Soul Bound</div>
                            </div>
                        </div>

                        <div className="p-4 glass-panel rounded-2xl">
                            <div className="text-[10px] uppercase text-zinc-500 font-bold tracking-widest mb-1 flex items-center gap-2">
                                <div className="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse" />
                                Current Soul
                            </div>
                            <div className="font-cinzel text-amber-100 text-lg">${gameState.characterName}</div>
                            <div className="text-[10px] text-zinc-500 mt-2 font-light italic">${gameState.location}</div>
                        </div>

                        <${StatsBar} health=${gameState.health} mana=${gameState.mana} />
                        <${Inventory} items=${gameState.inventory} />

                        <div className="mt-auto pt-6 border-t border-zinc-900 flex justify-between items-center opacity-30">
                             <span className="text-[8px] uppercase tracking-widest">Version 1.2.0</span>
                             <span className="text-[8px] uppercase tracking-widest">Gemini Engine</span>
                        </div>
                    </aside>

                    <main className="flex-1 flex flex-col relative h-screen">
                        <section className="h-[38%] relative border-b border-zinc-900 bg-black overflow-hidden group">
                            ${image ? html`
                                <img src=${image} className="w-full h-full object-cover opacity-60 transition-transform duration-[20s] scale-100 group-hover:scale-110" />
                            ` : html`
                                <div className="absolute inset-0 flex items-center justify-center font-cinzel text-zinc-800 uppercase tracking-widest text-xs">Visualizing the Beyond...</div>
                            `}
                            <div className="absolute inset-0 bg-gradient-to-t from-[#050505] via-[#050505]/20 to-transparent" />
                            
                            ${loading && html`
                                <div className="absolute top-6 right-6 flex items-center gap-3 px-4 py-2 glass-panel rounded-full animate-pulse z-10">
                                    <div className="w-2 h-2 rounded-full bg-amber-600" />
                                    <span className="text-[9px] text-amber-600 font-bold uppercase tracking-[0.2em]">The Void is Thinking</span>
                                </div>
                            `}
                        </section>

                        <div ref=${logRef} className="flex-1 overflow-y-auto p-8 space-y-8 scroll-smooth custom-scrollbar">
                            <div className="max-w-3xl mx-auto space-y-10 pb-12">
                                ${gameState.history.map((entry, idx) => html`
                                    <div key=${idx} className="animate-fade-in">
                                        ${entry.type === 'action' ? html`
                                            <div className="flex justify-end">
                                                <div className="glass-panel px-5 py-3 rounded-2xl text-sm italic text-amber-200/60 font-light border-amber-900/10">
                                                    "${entry.content}"
                                                </div>
                                            </div>
                                        ` : entry.type === 'system' ? html`
                                            <div className="text-center text-[10px] text-red-500/80 uppercase tracking-[0.3em] font-bold py-4">
                                                ${entry.content}
                                            </div>
                                        ` : html`
                                            <p className="leading-relaxed text-lg font-light text-zinc-300 drop-shadow-sm first-letter:text-3xl first-letter:font-cinzel first-letter:text-amber-700 first-letter:mr-1">
                                                ${entry.content}
                                            </p>
                                        `}
                                    </div>
                                `)}
                                ${loading && html`
                                    <div className="space-y-3 opacity-20">
                                        <div className="h-4 bg-zinc-800 rounded w-full animate-pulse" />
                                        <div className="h-4 bg-zinc-800 rounded w-5/6 animate-pulse" />
                                        <div className="h-4 bg-zinc-800 rounded w-4/6 animate-pulse" />
                                    </div>
                                `}
                            </div>
                        </div>

                        <div className="p-8 bg-[#080808] border-t border-zinc-900/50 relative z-10 shadow-[0_-20px_50px_rgba(0,0,0,0.5)]">
                            <form onSubmit=${handleAction} className="max-w-3xl mx-auto relative group">
                                <div className="absolute inset-0 bg-amber-900/5 rounded-2xl blur-xl opacity-0 group-focus-within:opacity-100 transition-opacity" />
                                <input 
                                    type="text" 
                                    value=${input}
                                    onChange=${e => setInput(e.target.value)}
                                    placeholder=${loading ? "Silence... destiny is being written." : "What will you do, hero?"}
                                    disabled=${loading}
                                    className="w-full bg-zinc-900/40 border border-zinc-800/80 rounded-2xl px-6 py-5 pr-16 text-sm focus:outline-none focus:border-amber-900/40 focus:bg-zinc-900/60 transition-all placeholder-zinc-700 text-zinc-100"
                                />
                                <button 
                                    type="submit" 
                                    disabled=${loading || !input.trim()}
                                    className="absolute right-3 top-1/2 -translate-y-1/2 p-3 text-amber-700 hover:text-amber-500 disabled:opacity-20 transition-all active:scale-90"
                                >
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" className="w-5 h-5" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                                        <line x1="22" y1="2" x2="11" y2="13"></line>
                                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </main>
                </div>
            `;
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>